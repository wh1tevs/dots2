#!/bin/bash

# TODO: Remove wsl-screenrec

[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${XDG_VIDEOS_DIR:-$HOME/Videos}/Screenrecords"

if [[ ! -d "$OUTPUT_DIR" ]]; then
  mkdir -p "$OUTPUT_DIR"
fi

# Selects region or output
SCOPE="$1"

# Selects audio inclusion or not
AUDIO=$([[ $2 == "audio" ]] && echo "--audio")

start_screenrecording() {
  local filename="$OUTPUT_DIR/screenrecording-$(date +'%Y-%m-%d_%H-%M-%S').mp4"
  local audio_flags="--audio=$(pactl list short sources | grep output | awk '{print $2}')"

  wf-recorder $([[ $2 == "audio" ]] && echo "$audio_flags") -f "$filename" -c libx264 -p crf=23 -p preset=medium -p movflags=+faststart "$@" &

  toggle_screenrecording_indicator
}

stop_screenrecording() {
  pkill -x wf-recorder

  notify-send "Screen recording" "saved to $OUTPUT_DIR" -t 2000

  sleep 0.2 # ensures the process is actually dead before we check
  toggle_screenrecording_indicator
}

toggle_screenrecording_indicator() {
  pkill -RTMIN+8 waybar
}

screenrecording_active() {
  pgrep -x wf-recorder >/dev/null
}

if screenrecording_active; then
  stop_screenrecording
elif [[ "$SCOPE" == "output" ]]; then
  output=$(slurp -o) || exit 1
  start_screenrecording -g "$output"
else
  region=$(slurp) || exit 1
  start_screenrecording -g "$region"
fi

# vim: ft=bash
